name: 'GitFlow Automation'
description: 'Automatise le workflow GitFlow avec gÃ©nÃ©ration de changelog et gestion des versions'
author: 'Quentin NCL - SINAPS Conseils'

inputs:
  github-token:
    description: 'GitHub token pour les opÃ©rations Git et API'
    required: true
  version:
    description: 'Version Ã  crÃ©er (format vX.Y.Z). Si non spÃ©cifiÃ©e, sera calculÃ©e automatiquement.'
    required: false
    default: ''
  node-version:
    description: 'Version de Node.js Ã  utiliser'
    required: false
    default: '18'
  project-name:
    description: 'Nom du projet pour les messages du changelog'
    required: false
    default: 'Project'
  run-tests:
    description: 'ExÃ©cuter les tests aprÃ¨s la prÃ©paration'
    required: false
    default: 'true'
  format-code:
    description: 'Formater le code automatiquement'
    required: false
    default: 'true'
  generate-docs:
    description: 'GÃ©nÃ©rer la documentation automatiquement'
    required: false
    default: 'true'
  commit-changes:
    description: 'Commiter automatiquement les changements'
    required: false
    default: 'true'

outputs:
  version:
    description: 'Version crÃ©Ã©e ou utilisÃ©e'
    value: ${{ steps.detect-version.outputs.version }}
  changelog-updated:
    description: 'Indique si le changelog a Ã©tÃ© mis Ã  jour'
    value: ${{ steps.generate-changelog.outputs.updated }}
  changes-committed:
    description: 'Indique si des changements ont Ã©tÃ© commitÃ©s'
    value: ${{ steps.commit-changes.outputs.committed }}
  version-code:
    description: 'Nouveau versionCode (pour React Native/Expo)'
    value: ${{ steps.update-versions.outputs.version-code }}

runs:
  using: 'composite'
  steps:
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ inputs.node-version }}

    - name: ğŸ“¦ Install dependencies
      shell: bash
      run: npm ci --legacy-peer-deps
      
    - name: ğŸ” Detect or validate version
      id: detect-version
      shell: bash
      run: ${{ github.action_path }}/scripts/detect-version.sh
      env:
        INPUT_VERSION: ${{ inputs.version }}
        PROJECT_NAME: ${{ inputs.project-name }}

    - name: ğŸ”„ Update versions in files
      id: update-versions
      shell: bash
      run: ${{ github.action_path }}/scripts/update-versions.sh
      env:
        VERSION: ${{ steps.detect-version.outputs.version }}

    - name: ğŸ“ Generate changelog
      id: generate-changelog
      shell: bash
      run: ${{ github.action_path }}/scripts/generate-changelog.sh "" "" "${{ steps.detect-version.outputs.version }}"
      env:
        PROJECT_NAME: ${{ inputs.project-name }}

    - name: ğŸ§ª Run tests
      if: inputs.run-tests == 'true'
      shell: bash
      run: npm test
      continue-on-error: false

    - name: ğŸ¨ Format code
      if: inputs.format-code == 'true'
      shell: bash
      run: npm run format || echo "âš ï¸ Format script not found"
      continue-on-error: true

    - name: ğŸ“š Generate documentation
      if: inputs.generate-docs == 'true'
      shell: bash
      run: npm run doc || echo "âš ï¸ Doc script not found"
      continue-on-error: true

    - name: ğŸ’¾ Commit changes
      if: inputs.commit-changes == 'true'
      id: commit-changes
      shell: bash
      run: ${{ github.action_path }}/scripts/commit-changes.sh
      env:
        GITHUB_TOKEN: ${{ inputs.github-token }}
        VERSION: ${{ steps.detect-version.outputs.version }}
        GITHUB_ACTOR: ${{ github.actor }}

branding:
  icon: 'git-branch'
  color: 'blue'
