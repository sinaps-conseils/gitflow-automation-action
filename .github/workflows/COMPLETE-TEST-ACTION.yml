name: ðŸ§ª Test GitFlow Action

on:
  workflow_dispatch:
    inputs:
      test-version:
        description: 'Version Ã  tester'
        required: true
        default: 'v1.0.1-test'
      test-type:
        description: 'Type de test'
        required: false
        default: 'manual'
        type: choice
        options:
          - manual
          - auto
          - branch
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test-basic:
    name: ðŸ§ª Test Formats de Version
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version: 
          - 'v1.0.1-test'
          - 'v2.0.0-alpha'
          - 'v1.5.0-beta.1'
          - '1.0.0'
          - 'v1.0.0'
          - 'auto'
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ CrÃ©er environnement de test
        run: |
          # CrÃ©er un package.json de test
          cat > package.json << 'EOF'
          {
            "name": "test-gitflow-action",
            "version": "1.0.0",
            "description": "Test pour l'action GitFlow",
            "scripts": {
              "test": "echo 'Test passed'",
              "build": "echo 'Build completed'",
              "lint": "echo 'Linting completed'"
            }
          }
          EOF
          
          # CrÃ©er un changelog de test
          cat > CHANGELOG.md << 'EOF'
          # Changelog
          
          ## [Unreleased]
          
          ### Added
          - Test setup
          
          ## [1.0.0] - 2025-01-01
          
          ### Added
          - Initial release
          EOF

      - name: ðŸ§ª Test Action (Mode Dry-Run)
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          version: ${{ github.event.inputs.test-version || 'v1.0.1-test' }}
          project-name: 'Test GitFlow Action'
          run-tests: 'true'
          commit-changes: 'false'  # Important: pas de commit en test
          format-code: 'false'
          generate-docs: 'false'
        id: test-action

      - name: ðŸ“Š RÃ©sultats du Test
        run: |
          echo "## ðŸ§ª RÃ©sultats du Test" >> $GITHUB_STEP_SUMMARY
          echo "- **Version dÃ©tectÃ©e:** ${{ steps.test-action.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changelog mis Ã  jour:** ${{ steps.test-action.outputs.changelog-updated }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version Code:** ${{ steps.test-action.outputs.version-code }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changements commitÃ©s:** ${{ steps.test-action.outputs.changes-committed }}" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ” VÃ©rifier les modifications
        run: |
          echo "=== Contenu du package.json aprÃ¨s test ==="
          cat package.json
          
          echo "=== DÃ©but du CHANGELOG.md modifiÃ© ==="
          head -n 20 CHANGELOG.md
          
          echo "=== Statut Git ==="
          git status --porcelain

  validate-structure:
    name: ðŸ” Validation Structure
    runs-on: ubuntu-latest
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        
      - name: ðŸ” VÃ©rifier la structure de l'action
        run: |
          echo "=== VÃ©rification de la structure ==="
          
          # VÃ©rifier action.yml
          if [ -f action.yml ]; then
            echo "âœ… action.yml prÃ©sent"
          else
            echo "âŒ action.yml manquant"
            exit 1
          fi
          
          # VÃ©rifier le dossier scripts
          if [ -d scripts ]; then
            echo "âœ… Dossier scripts prÃ©sent"
          else
            echo "âŒ Dossier scripts manquant"
            exit 1
          fi
          
          # VÃ©rifier les scripts individuels
          required_scripts=("detect-version.sh" "update-versions.sh" "generate-changelog.sh" "commit-changes.sh")
          for script in "${required_scripts[@]}"; do
            if [ -f "scripts/$script" ]; then
              echo "âœ… $script prÃ©sent"
              if [ -x "scripts/$script" ]; then
                echo "âœ… $script est exÃ©cutable"
              else
                echo "âŒ $script n'est pas exÃ©cutable"
                exit 1
              fi
            else
              echo "âŒ $script manquant"
              exit 1
            fi
          done
          
          echo "ðŸŽ‰ Structure validÃ©e avec succÃ¨s !"

  test-different-versions:
    name: ðŸ§ª Test DiffÃ©rents Types de Version
    runs-on: ubuntu-latest
    strategy:
      matrix:
        version-type: ['auto', 'manual']
        include:
          - version-type: 'auto'
            version: 'auto'
          - version-type: 'manual'
            version: 'v2.1.0-test'
    
    steps:
      - name: ðŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Setup pour test ${{ matrix.version-type }}
        run: |
          cat > package.json << 'EOF'
          {
            "name": "test-versions",
            "version": "1.5.0",
            "description": "Test versions",
            "scripts": {
              "test": "echo 'Test passed'"
            }
          }
          EOF
          
          cat > CHANGELOG.md << 'EOF'
          # Changelog
          
          ## [Unreleased]
          
          ## [1.5.0] - 2025-01-01
          ### Added
          - Version testing
          EOF

      - name: ðŸ§ª Test version ${{ matrix.version-type }}
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          version: ${{ matrix.version }}
          project-name: 'Test ${{ matrix.version-type }}'
          run-tests: 'false'
          commit-changes: 'false'
          format-code: 'false'
          generate-docs: 'false'
        id: test-version

      - name: ðŸ“Š RÃ©sultats ${{ matrix.version-type }}
        run: |
          echo "### Test ${{ matrix.version-type }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.test-version.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Changelog:** ${{ steps.test-version.outputs.changelog-updated }}" >> $GITHUB_STEP_SUMMARY